
rule qiime2_diversity:
    input:
        table = rules.qiime2_run_regions.output.table,
        tree = rules.qiime2_run_regions.output.tree,
        sample_info = rules.qiime2_sample_info.output
    params:
        outdir = join(QIIME2_INTERIM, 'diversity'),
        max_depth = 20000
    singularity:
        'docker://' + config['docker']['qiime2']
    output:
        join(QIIME2_INTERIM, 'diversity', 'shannon_vector.qza'),
        join(QIIME2_INTERIM, 'diversity', 'observed_otus_vector.qza'),
        join(QIIME2_INTERIM, 'diversity', 'faith_pd_vector.qza')
    shell:
        'qiime diversity core-metrics-phylogenetic '
        '--i-table {input.table} '
        '--i-phylogeny {input.tree} '
        '--m-metadata-file {input.sample_info} '
        '--p-sampling-depth {params.max_depth} '
        '--output-dir {params.outdir}'

rule qiime2_diversity_sampling:
    input:
        table = rules.qiime2_run_regions.output.table,
        tree = rules.qiime2_run_regions.output.tree,
        sample_info = rules.qiime2_sample_info.output 
    params:
        max_depth = 5000,
        metrics = '--p-metrics shannon --p-metrics faith_pd --p-metrics obeserved_otus '
    singularity:
        'docker://' + config['docker']['qiime2']
    output:
        join(QIIME2_INTERIM, 'diversity', 'alpha_rarefaction.qzv')
    shell:
        'qiime diversity alpha-rarefaction '
        '--i-table {input.table} '
        '--i-phylogeny {input.tree} '
        '--m-metadata-file {input.sample_info} '
        '--p-max-depth {params.max_depth} '
        '--o-visualization {output} '


rule qiime2_shannon_correlations:
    input:
        alpha = join(QIIME2_INTERIM, 'diversity', 'shannon_vector.qza'),
        sample_info = rules.qiime2_sample_info.output
    singularity:
        'docker://' + config['docker']['qiime2']
    output:
        join(QIIME2_INTERIM, 'diversity', 'shannon_group-significance.qzv')
    shell:
        'qiime diversity alpha-group-significance '
        ' --i-alpha-diversity {input.alpha} '
        '--m-metadata-file {input.sample_info} '
        '--o-visualization {output} '
        
rule qiime2_otu_correlations:
    input:
        alpha = join(QIIME2_INTERIM, 'diversity', 'observed_otus_vector.qza'),
        sample_info = rules.qiime2_sample_info.output
    singularity:
        'docker://' + config['docker']['qiime2']
    output:
        join(QIIME2_INTERIM, 'diversity', 'otus_group-significance.qzv')
    shell:
        'qiime diversity alpha-group-significance '
        ' --i-alpha-diversity {input.alpha} '
        '--m-metadata-file {input.sample_info} '
        '--o-visualization {output} '

rule qiime2_faith_pd_correlations:
    input:
        alpha = join(QIIME2_INTERIM, 'diversity', 'faith_pd_vector.qza'),
        sample_info = rules.qiime2_sample_info.output
    singularity:
        'docker://' + config['docker']['qiime2']
    output:
        join(QIIME2_INTERIM, '{denoiser}', 'faith_pd_group-significance.qzv')
    shell:
        'qiime diversity alpha-group-significance '
        ' --i-alpha-diversity {input.alpha} '
        '--m-metadata-file {input.sample_info} '
        '--o-visualization {output} '


rule qiime2_rpca:
    input:
        table = rules.qiime2_run_regions.output.table,
    params:
        args = '--p-min-feature-count 10 --p-min-sample-count 500 '
    singularity:
        'docker://' + config['docker']['qiime2']
    output:
        ordination = join(QIIME2_INTERIM, 'diversity', 'deicode_rpca.qza'),
        distance = join(QIIME2_INTERIM, 'diversity', 'deicode_distance.qza')
    shell:
        'qiime deicode rpca '
        '--i-table {input.table} '
        '--o-biplot {output.ordination} '
        '--o-distance-matrix {output.distance} '
        '{params.args} '
