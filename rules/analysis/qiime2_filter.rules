"""Conservative sample/feature filter 
"""



rule qiime2_sample_filter:
    input:
        table = join(QIIME2_INTERIM, '{denoiser}', 'table.qza')
    singularity:
        QIIME2_IMAGE    
    output:
        temp(join(QIIME2_INTERIM, '{denoiser}', 'filtered', '_table.qza'))
    shell:
        'qiime feature-table filter-samples '
        '--i-table {input.table} '
        '--p-min-frequency 1000 '
        '--p-min-features 10 '
        '--o-filtered-table {output} '

rule qiime2_feature_filter:
    input:
        table = join(QIIME2_INTERIM, '{denoiser}', 'filtered', '_table.qza')
    singularity:
        QIIME2_IMAGE    
    output:
        temp(join(QIIME2_INTERIM, '{denoiser}', 'filtered', 'table.qza'))
    shell:
        'qiime feature-table filter-features '
        '--i-table {input.table} '
        '--p-min-frequency 10 '
        '--p-min-samples 3 '
        '--o-filtered-table {output} '

rule qiime2_taxa_filter:
    input:
        table = join(QIIME2_INTERIM, '{denoiser}', 'filtered', 'table.qza'),
        taxa = join(QIIME2_INTERIM, '{denoiser}', '{db}', 'taxonomy.qza')
    singularity:
        QIIME2_IMAGE
    output:
        join(QIIME2_INTERIM, '{denoiser}', 'filtered', '{db}', 'table.qza')
    shell:
        'qiime taxa filter-table '
        '--i-table {input.table} '
        '--i-taxonomy {input.taxa} '
        '--p-exclude mitochondria,chloroplast '
        '--p-include bacteria '
        '--o-filtered-table {output} '
